name: Discord Bot 24/7

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    # ÙƒÙ„ 5 Ø³Ø§Ø¹Ø§Øª Ùˆ 30 Ø¯Ù‚ÙŠÙ‚Ø©
    - cron: "30 */5 * * *"

concurrency:
  group: discord-bot-runner
  cancel-in-progress: true

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 330  # 5.5 Ø³Ø§Ø¹Ø©
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: ðŸ“¦ Install
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ“ Setup Data
        run: mkdir -p data

      - name: ðŸ’¾ Restore Data
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: bot-data
          path: data/

      - name: ðŸ¤– Run Bot
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          GUILD_ID: ${{ secrets.GUILD_ID }}
          ADMIN_ROLE_ID: ${{ secrets.ADMIN_ROLE_ID }}
        run: |
          echo "ðŸš€ Bot Starting..."
          timeout 19800 python main.py || true
          echo "âœ… Run Complete"

      - name: ðŸ’¾ Save Data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-data
          path: data/
          retention-days: 90
          overwrite: true

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## ðŸ¤– Bot Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python**: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          if [ -f "data/accounts.json" ]; then
            echo "- **Data**: Saved âœ…" >> $GITHUB_STEP_SUMMARY
          fi
